<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>Merge</title>
  <link href="/codemirror/lib/codemirror.css" rel="stylesheet">
  <link href="/codemirror/addon/merge/merge.css" rel="stylesheet">
  <link href="/codemirror/theme/3024-day.css" rel="stylesheet">
  <link href="/codemirror/theme/3024-night.css" rel="stylesheet">
  <link href="/codemirror/theme/abcdef.css" rel="stylesheet">
  <link href="/codemirror/theme/ambiance.css" rel="stylesheet">
  <link href="/codemirror/theme/base16-dark.css" rel="stylesheet">
  <link href="/codemirror/theme/bespin.css" rel="stylesheet">
  <link href="/codemirror/theme/base16-light.css" rel="stylesheet">
  <link href="/codemirror/theme/blackboard.css" rel="stylesheet">
  <link href="/codemirror/theme/cobalt.css" rel="stylesheet">
  <link href="/codemirror/theme/colorforth.css" rel="stylesheet">
  <link href="/codemirror/theme/dracula.css" rel="stylesheet">
  <link href="/codemirror/theme/eclipse.css" rel="stylesheet">
  <link href="/codemirror/theme/elegant.css" rel="stylesheet">
  <link href="/codemirror/theme/erlang-dark.css" rel="stylesheet">
  <link href="/codemirror/theme/hopscotch.css" rel="stylesheet">
  <link href="/codemirror/theme/icecoder.css" rel="stylesheet">
  <link href="/codemirror/theme/isotope.css" rel="stylesheet">
  <link href="/codemirror/theme/lesser-dark.css" rel="stylesheet">
  <link href="/codemirror/theme/liquibyte.css" rel="stylesheet">
  <link href="/codemirror/theme/material.css" rel="stylesheet">
  <link href="/codemirror/theme/mbo.css" rel="stylesheet">
  <link href="/codemirror/theme/mdn-like.css" rel="stylesheet">
  <link href="/codemirror/theme/midnight.css" rel="stylesheet">
  <link href="/codemirror/theme/monokai.css" rel="stylesheet">
  <link href="/codemirror/theme/neat.css" rel="stylesheet">
  <link href="/codemirror/theme/neo.css" rel="stylesheet">
  <link href="/codemirror/theme/night.css" rel="stylesheet">
  <link href="/codemirror/theme/panda-syntax.css" rel="stylesheet">
  <link href="/codemirror/theme/paraiso-dark.css" rel="stylesheet">
  <link href="/codemirror/theme/paraiso-light.css" rel="stylesheet">
  <link href="/codemirror/theme/pastel-on-dark.css" rel="stylesheet">
  <link href="/codemirror/theme/railscasts.css" rel="stylesheet">
  <link href="/codemirror/theme/rubyblue.css" rel="stylesheet">
  <link href="/codemirror/theme/seti.css" rel="stylesheet">
  <link href="/codemirror/theme/solarized.css" rel="stylesheet">
  <link href="/codemirror/theme/the-matrix.css" rel="stylesheet">
  <link href="/codemirror/theme/tomorrow-night-bright.css" rel="stylesheet">
  <link href="/codemirror/theme/tomorrow-night-eighties.css" rel="stylesheet">
  <link href="/codemirror/theme/ttcn.css" rel="stylesheet">
  <link href="/codemirror/theme/twilight.css" rel="stylesheet">
  <link href="/codemirror/theme/vibrant-ink.css" rel="stylesheet">
  <link href="/codemirror/theme/xq-dark.css" rel="stylesheet">
  <link href="/codemirror/theme/xq-light.css" rel="stylesheet">
  <link href="/codemirror/theme/yeti.css" rel="stylesheet">
  <link href="/codemirror/theme/zenburn.css" rel="stylesheet">
  <link href="/codemirror/addon/hint/show-hint.css" rel="stylesheet">
  <link href="/codemirror/addon/lint/lint.css" rel="stylesheet">
  <link href="/codemirror/addon/fold/foldgutter.css" rel="stylesheet">
  <link href="/codemirror/addon/dialog/dialog.css" rel="stylesheet">
  <link href="/codemirror/addon/search/matchesonscrollbar.css" rel="stylesheet">
  <script src="/codemirror/lib/codemirror.js"></script>
  <script src="/codemirror/addon/selection/active-line.js"></script>
  <script src="/codemirror/addon/edit/matchbrackets.js"></script>
  <script src="/codemirror/addon/edit/matchbrackets.js"></script>
  <script src="/codemirror/addon/edit/closetag.js"></script>
  <script src="/codemirror/addon/edit/trailingspace.js"></script>
  <script src="/codemirror/addon/hint/show-hint.js"></script>
  <script src="/codemirror/addon/hint/anyword-hint.js"></script>
  <script src="/codemirror/addon/lint/lint.js"></script>
  <script src="/codemirror/addon/lint/json-lint.js"></script>
  <script src="/codemirror/addon/lint/javascript-lint.js"></script>
  <script src="/codemirror/addon/lint/css-lint.js"></script>
  <script src="/codemirror/addon/fold/foldcode.js"></script>
  <script src="/codemirror/addon/fold/foldgutter.js"></script>
  <script src="/codemirror/addon/fold/brace-fold.js"></script>
  <script src="/codemirror/addon/fold/xml-fold.js"></script>
  <script src="/codemirror/addon/fold/markdown-fold.js"></script>
  <script src="/codemirror/addon/fold/comment-fold.js"></script>
  <script src="/codemirror/addon/display/autorefresh.js"></script>
  <script src="/codemirror/addon/display/rulers.js"></script>
  <script src="/codemirror/addon/display/panel.js"></script>
  <script src="/codemirror/addon/comment/comment.js"></script>
  <script src="/codemirror/addon/dialog/dialog.js"></script>
  <script src="/codemirror/addon/search/jump-to-line.js"></script>
  <script src="/codemirror/addon/search/searchcursor.js"></script>
  <script src="/codemirror/addon/search/search.js"></script>
  <script src="/codemirror/addon/search/match-highlighter.js"></script>
  <script src="/codemirror/addon/search/matchesonscrollbar.js"></script>
  <script src="/codemirror/addon/scroll/annotatescrollbar.js"></script>
  <script src="/codemirror/addon/mode/loadmode.js"></script>
  <script src="/codemirror/mode/javascript/javascript.js"></script>
  <script src="/codemirror/mode/htmlmixed/htmlmixed.js"></script>
  <script src="/codemirror/addon/mode/simple.js"></script>
  <script src="/codemirror/addon/mode/overlay.js"></script>
  <script src="/codemirror/addon/mode/multiplex.js"></script>
  <script src="/codemirror/mode/meta.js"></script>
  <script src="/codemirror/addon/merge/merge.js"></script>
  <script src="/codemirror/addon/merge/merge.js"></script>
  <script src="/codemirror/addon/merge/merge.js"></script>
  <script src="/jquery/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/diff_match_patch/20121119/diff_match_patch.js"></script>
  <link href="/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <script src="/bootstrap/js/bootstrap.min.js"></script>
  <style>
    body {
      font-family: Monaco, 'Roboto Mono', monospace;
      margin: 2px;
    }

    .CodeMirror {
      line-height: 1.2;
      font-size: 18px;
    }

    div.container {
      margin-left: 10px;
    }

    .CodeMirror-merge-2pane .CodeMirror-merge-gap {
      width: 3%;
    }
    .CodeMirror-merge-copybuttons-right .CodeMirror-merge-copy {
      font-size: x-large;
    }
    .CodeMirror-merge-2pane .CodeMirror-merge-pane {
      width: 48%;
    }
  </style>
</head>

<body>
  <div align="center">
    <table style="width: 100%">
      <tbody>
        <tr>
          <td style="width: 40%; text-align: left;">
            <span class="badge badge-secondary">Local</span>
          </td>
          <td style="text-align: center">
            <button type="button" class="btn btn-sm btn-success" id="save-btn">Close</button>
          </td>
          <td style="width: 40%; text-align: right;">
            <span class="badge badge-secondary">Remote</span>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
  <div id="view"></div>

  <script>
    var mergeView;
    var diffOnly = false;

    function resizeView() {
      var h = $(window).height() - 50;
      $("div.CodeMirror").height(h);
      $("div.CodeMirror-merge-editor").height(h);
      $("div.CodeMirror-merge").height(h);
      $("div#view").height(h);
      mergeView.editor().refresh();
      mergeView.rightOriginal().refresh();
    }

    function detectMode(filename) {
      var info = CodeMirror.findModeByFileName(filename);
      var mode, spec;
      if (info) {
        mode = info.mode;
        spec = info.mime;
        if (spec === 'text/x-csrc') {
          spec = 'text/x-c++src';
        }
      } else {
        mode = null;
        spec = 'text/plain';
      }
      return {
        Mode: mode,
        Spec: spec
      };
    }

    function trySave() {
      if (diffOnly) {
        $.get("/close");
        return;
      }
      var request = {
        Content: mergeView.editor().getDoc().getValue(),
      };
      $.post("/save", request, function(resp) {
        if (resp.Status == 'OK') {
          $.get("/close");
        } else {
          console.log(resp.Message);
          alert("Error saving merged file: " + resp.Message);
        }
        $("body").html("<b>You can now close the window.</b>");
      }).fail(function() {
        alert('An error occured while trying to save the file.');
      });
    }

    function initUI() {
      $.get('/get-local-remote').done(function(data) {
        diffOnly = data.DiffOnly;
        if (data.DiffOnly) {
          $('#save-btn').html("Close");
        } else {
          $('#save-btn').html("Save & Close");
        }
        var target = document.getElementById("view");
        target.innerHTML = "";
        mergeView = CodeMirror.MergeView(target, {
          theme: 'default',
          value: data.LocalContent,
          origLeft: null,
          orig: data.RemoteContent,
          lineNumbers: true,
          mode: null,
          highlightDifferences: true,
          connect: "align",
          collapseIdentical: false
        });
        var mime = detectMode(data.Filename);
        document.title = "Merging " + data.Filename;
        CodeMirror.autoLoadMode(mergeView.editor(), mime.Mode);
        CodeMirror.autoLoadMode(mergeView.rightOriginal(), mime.Mode);
        mergeView.options.mode = mime.Mode;
        mergeView.editor().setOption('mode', mime.Spec);
        mergeView.rightOriginal().setOption('mode', mime.Spec);
        resizeView();
      }).fail(function() {
        alert('Failed to open the file.');
      });
    }

    $(window).resize(function() {
      resizeView();
    });

    window.onload = function() {
      initUI();
      $("#save-btn").click(function() {
        trySave();
      });
    };

    $.get("/heartbeat");
    setInterval(function() {
      $.get("/heartbeat");
    }, 1000);
  </script>

</body>

</html>
